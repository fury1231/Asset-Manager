<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetGo! è²¡ç”¢æ¸…å†Šæƒæç³»çµ±</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        window.GAS_API_URL = "https://script.google.com/macros/s/AKfycbyChQMJO3AniFU9dvNz5cIsoreX-R8jwCoGfYW6oL861BmODLoH3Eyrml_28jON68MO0g/exec";
    </script>

    <script type="module">
        import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";
        

        let videoElem, scanner;
        const startScanBtn = document.getElementById("startScan");
        const stopScanBtn = document.getElementById("stopScan");
        const resultElem = document.getElementById("result");

        async function startScanner() {
            if (!videoElem) {
                videoElem = document.createElement("video");
                videoElem.setAttribute("id", "video");
                document.getElementById("reader").appendChild(videoElem);
            }

            try {
                const cameras = await QrScanner.listCameras();
                if (cameras.length === 0) throw new Error("âŒ æ‰¾ä¸åˆ°å¯ç”¨ç›¸æ©Ÿ");

                let backCamera = cameras.find(camera => 
                    camera.label.toLowerCase().includes("back") || 
                    camera.label.includes("ç’°å¢ƒ")
                );
                let selectedCameraId = backCamera ? backCamera.id : cameras[0].id;

                scanner = new QrScanner(videoElem, result => {
                    let scannedData = result.data; // ç¢ºä¿æ˜¯å­—ä¸²
                    resultElem.textContent = `âœ… æƒææˆåŠŸ: ${scannedData}`;
                    stopScanner();
                    fetchAssetInfo(scannedData);
                }, {
                    preferredCamera: selectedCameraId,
                    highlightScanRegion: true,
                    highlightCodeOutline: true
                });

                await scanner.start();
                startScanBtn.style.display = "none";
                stopScanBtn.style.display = "inline-block";
            } catch (error) {
                console.error(error);
                alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š" + error.message);
            }
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop();
                scanner.destroy();
                scanner = null;
            }
            startScanBtn.style.display = "inline-block";
            stopScanBtn.style.display = "none";
        }

        function fetchAssetInfo(assetId) {
            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("ğŸ“¡ å–å¾—è³‡ç”¢è³‡è¨Š:", data);
                    
                    if (data.error) {
                        alert("âŒ æ‰¾ä¸åˆ°è©²è³‡ç”¢: " + assetId);
                        return;
                    }

                    document.getElementById("assetId").value = data.assetId || "";
                    document.getElementById("assetName").value = data.assetName || "";
                    document.getElementById("user").value = data.user || "";
                    document.getElementById("location").value = data.location || "";

                    // è®“ç‹€æ…‹ä¸‹æ‹‰é¸å–®é è¨­é¸æ“‡ API å›å‚³çš„å€¼
                    const statusSelect = document.getElementById("status");
                    statusSelect.value = data.status || "æ­£å¸¸";
                })
                .catch(error => {
                    console.error("âŒ å–å¾—è³‡ç”¢è³‡è¨Šå¤±æ•—", error);
                    alert("âŒ å–å¾—è³‡ç”¢è³‡è¨Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API URL");
                });
        }

        document.getElementById("startScan").addEventListener("click", startScanner);
        document.getElementById("stopScan").addEventListener("click", stopScanner);
    </script>

    <!-- ä¿®æ­£ updateAsset()ï¼Œè®“ HTML å¯ä»¥èª¿ç”¨ -->
    <script>
        function updateAsset() {
            let assetId = document.getElementById("assetId").value;
            let assetName = document.getElementById("assetName").value;
            let user = document.getElementById("user").value;
            let location = document.getElementById("location").value;
            let status = document.getElementById("status").value;

            // å¾ Sheets å–å¾— QR Codeï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    let qrCode = data.qrCode || `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

                    fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}&qrCode=${encodeURIComponent(qrCode)}`)
                        .then(response => response.text())
                        .then(data => alert(data))
                        .catch(error => console.error("âŒ æ›´æ–°å¤±æ•—", error));
                })
                .catch(error => console.error("âŒ å–å¾— QR Code å¤±æ•—", error));
        }
        function generatePrintQrCode() {
            let assetId = document.getElementById("printAssetId").value;

            if (!assetId) {
                alert("âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥è²¡ç”¢ç·¨è™Ÿï¼");
                return;
            }

            let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;
            
            let qrCodeImg = document.getElementById("printQrCodeImage");
            qrCodeImg.src = qrCodeUrl;
            qrCodeImg.style.display = "block"; // é¡¯ç¤º QR Code
            console.log("generatePrintQrCode is working");
        }



        function generatePrintQrRange() {
            let startNum = document.getElementById("startAssetNum").value;
            let endNum = document.getElementById("endAssetNum").value;
            let qrPreviewDiv = document.getElementById("qrPreview");
            qrPreviewDiv.innerHTML = ""; // æ¸…ç©ºèˆŠçš„ QR Code

            if (!startNum || !endNum || isNaN(startNum) || isNaN(endNum)) {
                alert("âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¯„åœæ•¸å­—ï¼");
                return;
            }

            startNum = parseInt(startNum, 10);
            endNum = parseInt(endNum, 10);

            if (startNum > endNum) {
                alert("âŒ é–‹å§‹ç·¨è™Ÿä¸èƒ½å¤§æ–¼çµæŸç·¨è™Ÿï¼");
                return;
            }

            for (let i = startNum; i <= endNum; i++) {
                let assetId = "ASSET" + String(i).padStart(4, '0'); // è‡ªå‹•è£œ 4 ä½æ•¸
                let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

                let qrDiv = document.createElement("div");
                qrDiv.classList.add("col");  // è®“å®ƒé©æ‡‰ Bootstrap Grid
                qrDiv.innerHTML = `
                    <div class="card p-2 text-center">
                        <img src="${qrCodeUrl}" alt="QR Code" class="img-fluid mx-auto">
                        <p class="fw-bold mt-2">${assetId}</p>
                    </div>
                `;
                qrPreviewDiv.appendChild(qrDiv);
            }
        }



        function toggleAssetSection() {
            const section = document.getElementById("assetSection");
            const currentDisplay = window.getComputedStyle(section).display; // å–å¾—ç•¶å‰ CSS è¨­å®šçš„ display
            
            section.style.display = currentDisplay === "none" ? "block" : "none";
        }
        function toggleNewAssetSection() {
            const section = document.getElementById("newAssetSection");
            const currentDisplay = window.getComputedStyle(section).display;

            section.style.display = currentDisplay === "none" ? "block" : "none";

            if (section.style.display === "block") {
                fetchNextAssetId(); //å–å¾—ä¸‹ä¸€å€‹å¯ç”¨çš„ ASSET ID
            }
        }
        function togglePrintQrSection() {
        const section = document.getElementById("printQrSection");

            if (section.style.display === "" || section.style.display === "none") {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }
        function toggleEditAssetSection() {
            const section = document.getElementById("editAssetSection");

            if (section.style.display === "" || section.style.display === "none") {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }


        function editFetchAssetInfo() {
            let assetIdInput = document.getElementById("editAssetId").value.trim();
            
            // å¦‚æœä½¿ç”¨è€…åªè¼¸å…¥æ•¸å­—ï¼Œå°±è‡ªå‹•è£œä¸Š "ASSET"
            let assetId = assetIdInput.startsWith("ASSET") ? assetIdInput : `ASSET${assetIdInput.padStart(4, "0")}`;

            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("ğŸ“¡ å–å¾—è³‡ç”¢è³‡è¨Š:", data);
                    
                    if (data.error) {
                        alert("âŒ æ‰¾ä¸åˆ°è©²è³‡ç”¢: " + assetId);
                        return;
                    }

                    document.getElementById("editAssetId").value = data.assetId || "";
                    document.getElementById("editAssetName").value = data.assetName || "";
                    document.getElementById("editUser").value = data.user || "";
                    document.getElementById("editLocation").value = data.location || "";

                    const statusSelect = document.getElementById("editStatus");
                    statusSelect.value = data.status || "æ­£å¸¸";
                })
                .catch(error => {
                    console.error("âŒ å–å¾—è³‡ç”¢è³‡è¨Šå¤±æ•—", error);
                    alert("âŒ å–å¾—è³‡ç”¢è³‡è¨Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API URL");
                });
        }

        function updateEditAsset() {
            let assetId = document.getElementById("editAssetId").value.trim();
            let assetName = document.getElementById("editAssetName").value.trim();
            let user = document.getElementById("editUser").value.trim();
            let location = document.getElementById("editLocation").value.trim();
            let status = document.getElementById("editStatus").value;

            // å¦‚æœè³‡ç”¢ç·¨è™Ÿæ²’æœ‰è¼¸å…¥ï¼Œå‰‡ä¸åŸ·è¡Œæ›´æ–°
            if (!assetId) {
                alert("âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¡ç”¢ç·¨è™Ÿï¼");
                return;
            }

            // **ç¢ºä¿ ASSET ID æ ¼å¼æ­£ç¢º**
            assetId = assetId.startsWith("ASSET") ? assetId : `ASSET${assetId.padStart(4, "0")}`;

            fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}`)
                .then(response => response.text())
                .then(data => {
                    alert(`âœ… ${data}`);
                })
                .catch(error => {
                    console.error("âŒ æ›´æ–°å¤±æ•—", error);
                    alert("âŒ æ›´æ–°è³‡ç”¢å¤±æ•—ï¼");
                });
        }





        function fetchNextAssetId() {
            fetch(`${window.GAS_API_URL}?action=getNextAssetId`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("newAssetId").value = data.nextAssetId; // é¡¯ç¤ºæ–°ID
                })
                .catch(error => console.error("âŒ å–å¾—æ–° ASSET ID å¤±æ•—", error));
        }
        function printQrCode() {
            let qrPreviewDiv = document.getElementById("qrPreview");
            let qrImages = qrPreviewDiv.querySelectorAll("img");

            if (qrImages.length === 0) {
                alert("âŒ è«‹å…ˆç”¢ç”Ÿ QR Codeï¼");
                return;
            }

            const jsPDF = window.jspdf.jsPDF;
            const pdf = new jsPDF("p", "mm", "a4");
            let x = 10, y = 10, qrSize = 40, cols = 4, rows = 5, count = 0;

            qrImages.forEach((img, index) => {
                let assetId = img.nextElementSibling.textContent; // è®€å–å°æ‡‰çš„ ASSET ID
                pdf.addImage(img.src, "PNG", x, y, qrSize, qrSize);
                pdf.text(assetId, x, y + qrSize + 5);

                x += 50; // ç§»å‹•åˆ°ä¸‹ä¸€æ¬„
                count++;

                if (count % cols === 0) {
                    x = 10;
                    y += 60; // ä¸‹ä¸€è¡Œ
                }
                if (count % (cols * rows) === 0) {
                    pdf.addPage();
                    x = 10;
                    y = 10;
                }
            });

            pdf.save("QRCodes.pdf");
        }






        function createNewAsset() {
            let assetId = document.getElementById("newAssetId").value;
            let assetName = document.getElementById("newAssetName").value;
            let user = document.getElementById("newUser").value;
            let location = document.getElementById("newLocation").value;
            let status = document.getElementById("newStatus").value;

            if (!assetId) {
                alert("âŒ éŒ¯èª¤ï¼šç„¡æ³•å–å¾—æ–°çš„è²¡ç”¢ç·¨è™Ÿï¼");
                return;
            }

            // ç”Ÿæˆ QR Code URL
            let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

            fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}&qrCode=${encodeURIComponent(qrCodeUrl)}`)
                .then(response => response.text())
                .then(data => {
                    alert(data);

                    // ç¢ºä¿ QR Code åœ–ç‰‡å­˜åœ¨ä¸¦é¡¯ç¤º
                    let qrCodeImg = document.getElementById("qrCodeImage");
                    if (qrCodeImg) {
                        qrCodeImg.src = qrCodeUrl;
                        qrCodeImg.style.display = "block";
                    } else {
                        console.error("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° qrCodeImage å…ƒç´ ");
                    }

                    // // å»¶é²é—œé–‰æ–°å»ºè³‡ç”¢å€ï¼Œé¿å… QR Code æ¶ˆå¤±å¤ªå¿«
                    // setTimeout(() => {
                    //     toggleNewAssetSection();
                    // }, 2000);
                })
                .catch(error => console.error("âŒ æ–°å»ºè³‡ç”¢å¤±æ•—", error));
        }


    </script>

    <style>
        #printQrSection {
            display: none;
        }
        #reader {
            width: 320px;
            height: 320px;
            margin: auto;
            border: 2px solid #007bff;
            border-radius: 10px;
            background-color: black;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        input, button, select {
            display: block;
            margin: 10px auto;
            padding: 8px;
            width: 90%;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #assetSection {
            display: none; /* é è¨­éš±è—æƒæå€ */
        }
        #newAssetSection {
            display: none; /* é è¨­éš±è— */
        }
        #startScan, #stopScan {
            width: auto;  /* è®“æŒ‰éˆ•å¤§å°ä¾ç…§å…§å®¹ç¸®æ”¾ */
            padding: 6px 12px;  /* æ§åˆ¶æŒ‰éˆ•å…§é‚Šè·ï¼Œè®“å®ƒä¸æœƒå¤ªå° */
            font-size: 14px;  /* è®“å­—é«”é©ä¸­ */
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;  /* è®“æŒ‰éˆ•æœ‰é–“è· */
        }
    </style>
</head>
<body>

    <!-- <h2 class="text-center mt-3">è²¡ç”¢æ¸…å†Šæƒæç³»çµ±</h2> -->
    <div class="container mt-3">
        <div class="d-flex justify-content-center gap-3 flex-wrap my-3">
            <button class="btn btn-primary px-4" style="max-width: 200px;" onclick="toggleAssetSection()">ğŸ“· æƒæåŠŸèƒ½</button>
            <button class="btn btn-success px-4" style="max-width: 200px;" onclick="toggleNewAssetSection()">â• æ–°å»ºè³‡ç”¢</button>
            <button class="btn btn-warning px-4" style="max-width: 200px;" onclick="toggleEditAssetSection()">âœï¸ ç·¨è¼¯æ¨¡å¼</button>
            <button class="btn btn-secondary px-4" style="max-width: 200px;" onclick="togglePrintQrSection()">ğŸ“„ åˆ—å° QR Code</button>
        </div>
        
    </div>








    <div id="assetSection" class="card shadow p-4 mt-3 rounded-3">
        <div class="button-container">
            <button id="startScan" class="btn btn-primary">é–‹å§‹æƒæ</button>
            <button id="stopScan" class="btn btn-danger" style="display: none;">åœæ­¢æƒæ</button>
        </div>


    <div id="reader"></div>
    <p>æƒæçµæœ: <span id="result"></span></p>
    
    <h3>è³‡ç”¢è³‡è¨Š</h3>
    <input id="assetId" class="form-control my-3 border-primary fw-bold" placeholder="è²¡ç”¢ç·¨è™Ÿ" readonly>
    <input id="assetName" class="form-control my-3" placeholder="è²¡ç”¢åç¨±">
    <input id="user" class="form-control my-3" placeholder="ç•¶å‰ä½¿ç”¨è€…">
    <input id="location" class="form-control my-3" placeholder="å­˜æ”¾ä½ç½®">

    <!-- æ”¹æˆä¸‹æ‹‰å¼é¸å–® -->
    <select id="status" class="form-select my-2">
        <option value="æ­£å¸¸">æ­£å¸¸</option>
        <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
        <option value="å ±å»¢">å ±å»¢</option>
    </select>

    <button onclick="updateAsset()">æ›´æ–°è³‡ç”¢</button>

    </div>
    <div id="newAssetSection" class="card shadow p-4 mt-3 rounded-3">
        <h3>æ–°å»ºè³‡ç”¢</h3>
        <input id="newAssetId" placeholder="è²¡ç”¢ç·¨è™Ÿ" readonly>
        <input id="newAssetName" placeholder="è²¡ç”¢åç¨±">
        <input id="newUser" placeholder="ç•¶å‰ä½¿ç”¨è€…">
        <input id="newLocation" placeholder="å­˜æ”¾ä½ç½®">
    
        <select id="newStatus">
            <option value="æ­£å¸¸">æ­£å¸¸</option>
            <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
            <option value="å ±å»¢">å ±å»¢</option>
        </select>
    
        <button onclick="createNewAsset()">æ–°å»ºè³‡ç”¢</button>

    </div>

    <div id="printQrSection" class="card shadow p-3 mt-3">
        <h4 class="text-center">ğŸ“„ åˆ—å° QR Code</h4>
    

        <input id="startAssetNum" class="form-control my-2" placeholder="é–‹å§‹ç·¨è™Ÿ (0001é–‹å§‹)">
        <input id="endAssetNum" class="form-control my-2" placeholder="çµæŸç·¨è™Ÿ (æ¯”å¦‚0010)">
        <button class="btn btn-info w-100 my-2" onclick="generatePrintQrRange()">ğŸ” ç”¢ç”Ÿ QR Code</button>
        <button class="btn btn-success w-100 my-2" onclick="printQrCode()">ğŸ–¨ åˆ—å° QR Code</button>
        <div id="qrPreview" class="row row-cols-2 row-cols-md-4 g-3"></div>





    </div>
    <div id="editAssetSection" class="card shadow p-4 mt-3 rounded-3" style="display: none;">
        <h3>âœï¸ ç·¨è¼¯æ¨¡å¼</h3>
        <div class="input-group my-3">
            <span class="input-group-text">ASSET</span>
            <input id="editAssetId" type="text" class="form-control" placeholder="è¼¸å…¥è²¡ç”¢ç·¨è™Ÿ (å¦‚ 0001)">
            <button class="btn btn-secondary w-25" onclick="editFetchAssetInfo()">ç¢ºèª</button>
        </div>
    
        <h3>è³‡ç”¢è³‡è¨Š</h3>
        <input id="editAssetName" class="form-control my-3" placeholder="è²¡ç”¢åç¨±">
        <input id="editUser" class="form-control my-3" placeholder="ç•¶å‰ä½¿ç”¨è€…">
        <input id="editLocation" class="form-control my-3" placeholder="å­˜æ”¾ä½ç½®">
    
        <select id="editStatus" class="form-select my-2">
            <option value="æ­£å¸¸">æ­£å¸¸</option>
            <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
            <option value="å ±å»¢">å ±å»¢</option>
        </select>
    
        <button class="btn btn-primary w-100" onclick="updateEditAsset()">âœ… æ›´æ–°è³‡ç”¢</button>
    </div>

</body>
</html>
