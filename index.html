<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetGo! 財產清冊掃描系統</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        window.GAS_API_URL = "https://script.google.com/macros/s/AKfycbyChQMJO3AniFU9dvNz5cIsoreX-R8jwCoGfYW6oL861BmODLoH3Eyrml_28jON68MO0g/exec";
    </script>

    <script type="module">
        import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";
        

        let videoElem, scanner;
        const startScanBtn = document.getElementById("startScan");
        const stopScanBtn = document.getElementById("stopScan");
        const resultElem = document.getElementById("result");

        async function startScanner() {
            if (!videoElem) {
                videoElem = document.createElement("video");
                videoElem.setAttribute("id", "video");
                document.getElementById("reader").appendChild(videoElem);
            }

            try {
                const cameras = await QrScanner.listCameras();
                if (cameras.length === 0) throw new Error("❌ 找不到可用相機");

                let backCamera = cameras.find(camera => 
                    camera.label.toLowerCase().includes("back") || 
                    camera.label.includes("環境")
                );
                let selectedCameraId = backCamera ? backCamera.id : cameras[0].id;

                scanner = new QrScanner(videoElem, result => {
                    let scannedData = result.data; // 確保是字串
                    resultElem.textContent = `✅ 掃描成功: ${scannedData}`;
                    stopScanner();
                    fetchAssetInfo(scannedData);
                }, {
                    preferredCamera: selectedCameraId,
                    highlightScanRegion: true,
                    highlightCodeOutline: true
                });

                await scanner.start();
                startScanBtn.style.display = "none";
                stopScanBtn.style.display = "inline-block";
            } catch (error) {
                console.error(error);
                alert("無法開啟相機：" + error.message);
            }
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop();
                scanner.destroy();
                scanner = null;
            }
            startScanBtn.style.display = "inline-block";
            stopScanBtn.style.display = "none";
        }

        function fetchAssetInfo(assetId) {
            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("📡 取得資產資訊:", data);
                    
                    if (data.error) {
                        alert("❌ 找不到該資產: " + assetId);
                        return;
                    }

                    document.getElementById("assetId").value = data.assetId || "";
                    document.getElementById("assetName").value = data.assetName || "";
                    document.getElementById("user").value = data.user || "";
                    document.getElementById("location").value = data.location || "";

                    // 讓狀態下拉選單預設選擇 API 回傳的值
                    const statusSelect = document.getElementById("status");
                    statusSelect.value = data.status || "正常";
                })
                .catch(error => {
                    console.error("❌ 取得資產資訊失敗", error);
                    alert("❌ 取得資產資訊失敗，請檢查 API URL");
                });
        }

        document.getElementById("startScan").addEventListener("click", startScanner);
        document.getElementById("stopScan").addEventListener("click", stopScanner);
    </script>

    <!-- 修正 updateAsset()，讓 HTML 可以調用 -->
    <script>
        function updateAsset() {
            let assetId = document.getElementById("assetId").value;
            let assetName = document.getElementById("assetName").value;
            let user = document.getElementById("user").value;
            let location = document.getElementById("location").value;
            let status = document.getElementById("status").value;

            // 從 Sheets 取得 QR Code（如果已存在）
            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    let qrCode = data.qrCode || `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

                    fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}&qrCode=${encodeURIComponent(qrCode)}`)
                        .then(response => response.text())
                        .then(data => alert(data))
                        .catch(error => console.error("❌ 更新失敗", error));
                })
                .catch(error => console.error("❌ 取得 QR Code 失敗", error));
        }
        function generatePrintQrCode() {
            let assetId = document.getElementById("printAssetId").value;

            if (!assetId) {
                alert("❌ 錯誤：請輸入財產編號！");
                return;
            }

            let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;
            
            let qrCodeImg = document.getElementById("printQrCodeImage");
            qrCodeImg.src = qrCodeUrl;
            qrCodeImg.style.display = "block"; // 顯示 QR Code
            console.log("generatePrintQrCode is working");
        }



        function generatePrintQrRange() {
            let startNum = document.getElementById("startAssetNum").value;
            let endNum = document.getElementById("endAssetNum").value;
            let qrPreviewDiv = document.getElementById("qrPreview");
            qrPreviewDiv.innerHTML = ""; // 清空舊的 QR Code

            if (!startNum || !endNum || isNaN(startNum) || isNaN(endNum)) {
                alert("❌ 請輸入有效的範圍數字！");
                return;
            }

            startNum = parseInt(startNum, 10);
            endNum = parseInt(endNum, 10);

            if (startNum > endNum) {
                alert("❌ 開始編號不能大於結束編號！");
                return;
            }

            for (let i = startNum; i <= endNum; i++) {
                let assetId = "ASSET" + String(i).padStart(4, '0'); // 自動補 4 位數
                let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

                let qrDiv = document.createElement("div");
                qrDiv.classList.add("col");  // 讓它適應 Bootstrap Grid
                qrDiv.innerHTML = `
                    <div class="card p-2 text-center">
                        <img src="${qrCodeUrl}" alt="QR Code" class="img-fluid mx-auto">
                        <p class="fw-bold mt-2">${assetId}</p>
                    </div>
                `;
                qrPreviewDiv.appendChild(qrDiv);
            }
        }



        function toggleAssetSection() {
            const section = document.getElementById("assetSection");
            const currentDisplay = window.getComputedStyle(section).display; // 取得當前 CSS 設定的 display
            
            section.style.display = currentDisplay === "none" ? "block" : "none";
        }
        function toggleNewAssetSection() {
            const section = document.getElementById("newAssetSection");
            const currentDisplay = window.getComputedStyle(section).display;

            section.style.display = currentDisplay === "none" ? "block" : "none";

            if (section.style.display === "block") {
                fetchNextAssetId(); //取得下一個可用的 ASSET ID
            }
        }
        function togglePrintQrSection() {
        const section = document.getElementById("printQrSection");

            if (section.style.display === "" || section.style.display === "none") {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }
        function toggleEditAssetSection() {
            const section = document.getElementById("editAssetSection");

            if (section.style.display === "" || section.style.display === "none") {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }


        function editFetchAssetInfo() {
            let assetIdInput = document.getElementById("editAssetId").value.trim();
            
            // 如果使用者只輸入數字，就自動補上 "ASSET"
            let assetId = assetIdInput.startsWith("ASSET") ? assetIdInput : `ASSET${assetIdInput.padStart(4, "0")}`;

            fetch(`${window.GAS_API_URL}?action=getAssetInfo&assetId=${encodeURIComponent(assetId)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("📡 取得資產資訊:", data);
                    
                    if (data.error) {
                        alert("❌ 找不到該資產: " + assetId);
                        return;
                    }

                    document.getElementById("editAssetId").value = data.assetId || "";
                    document.getElementById("editAssetName").value = data.assetName || "";
                    document.getElementById("editUser").value = data.user || "";
                    document.getElementById("editLocation").value = data.location || "";

                    const statusSelect = document.getElementById("editStatus");
                    statusSelect.value = data.status || "正常";
                })
                .catch(error => {
                    console.error("❌ 取得資產資訊失敗", error);
                    alert("❌ 取得資產資訊失敗，請檢查 API URL");
                });
        }

        function updateEditAsset() {
            let assetId = document.getElementById("editAssetId").value.trim();
            let assetName = document.getElementById("editAssetName").value.trim();
            let user = document.getElementById("editUser").value.trim();
            let location = document.getElementById("editLocation").value.trim();
            let status = document.getElementById("editStatus").value;

            // 如果資產編號沒有輸入，則不執行更新
            if (!assetId) {
                alert("❌ 請輸入有效的財產編號！");
                return;
            }

            // **確保 ASSET ID 格式正確**
            assetId = assetId.startsWith("ASSET") ? assetId : `ASSET${assetId.padStart(4, "0")}`;

            fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}`)
                .then(response => response.text())
                .then(data => {
                    alert(`✅ ${data}`);
                })
                .catch(error => {
                    console.error("❌ 更新失敗", error);
                    alert("❌ 更新資產失敗！");
                });
        }





        function fetchNextAssetId() {
            fetch(`${window.GAS_API_URL}?action=getNextAssetId`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("newAssetId").value = data.nextAssetId; // 顯示新ID
                })
                .catch(error => console.error("❌ 取得新 ASSET ID 失敗", error));
        }
        function printQrCode() {
            let qrPreviewDiv = document.getElementById("qrPreview");
            let qrImages = qrPreviewDiv.querySelectorAll("img");

            if (qrImages.length === 0) {
                alert("❌ 請先產生 QR Code！");
                return;
            }

            const jsPDF = window.jspdf.jsPDF;
            const pdf = new jsPDF("p", "mm", "a4");
            let x = 10, y = 10, qrSize = 40, cols = 4, rows = 5, count = 0;

            qrImages.forEach((img, index) => {
                let assetId = img.nextElementSibling.textContent; // 讀取對應的 ASSET ID
                pdf.addImage(img.src, "PNG", x, y, qrSize, qrSize);
                pdf.text(assetId, x, y + qrSize + 5);

                x += 50; // 移動到下一欄
                count++;

                if (count % cols === 0) {
                    x = 10;
                    y += 60; // 下一行
                }
                if (count % (cols * rows) === 0) {
                    pdf.addPage();
                    x = 10;
                    y = 10;
                }
            });

            pdf.save("QRCodes.pdf");
        }






        function createNewAsset() {
            let assetId = document.getElementById("newAssetId").value;
            let assetName = document.getElementById("newAssetName").value;
            let user = document.getElementById("newUser").value;
            let location = document.getElementById("newLocation").value;
            let status = document.getElementById("newStatus").value;

            if (!assetId) {
                alert("❌ 錯誤：無法取得新的財產編號！");
                return;
            }

            // 生成 QR Code URL
            let qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(assetId)}&size=150`;

            fetch(`${window.GAS_API_URL}?action=updateAssetInfo&assetId=${encodeURIComponent(assetId)}&assetName=${encodeURIComponent(assetName)}&user=${encodeURIComponent(user)}&location=${encodeURIComponent(location)}&status=${encodeURIComponent(status)}&qrCode=${encodeURIComponent(qrCodeUrl)}`)
                .then(response => response.text())
                .then(data => {
                    alert(data);

                    // 確保 QR Code 圖片存在並顯示
                    let qrCodeImg = document.getElementById("qrCodeImage");
                    if (qrCodeImg) {
                        qrCodeImg.src = qrCodeUrl;
                        qrCodeImg.style.display = "block";
                    } else {
                        console.error("❌ 錯誤：找不到 qrCodeImage 元素");
                    }

                    // // 延遲關閉新建資產區，避免 QR Code 消失太快
                    // setTimeout(() => {
                    //     toggleNewAssetSection();
                    // }, 2000);
                })
                .catch(error => console.error("❌ 新建資產失敗", error));
        }


    </script>

    <style>
        #printQrSection {
            display: none;
        }
        #reader {
            width: 320px;
            height: 320px;
            margin: auto;
            border: 2px solid #007bff;
            border-radius: 10px;
            background-color: black;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        input, button, select {
            display: block;
            margin: 10px auto;
            padding: 8px;
            width: 90%;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #assetSection {
            display: none; /* 預設隱藏掃描區 */
        }
        #newAssetSection {
            display: none; /* 預設隱藏 */
        }
        #startScan, #stopScan {
            width: auto;  /* 讓按鈕大小依照內容縮放 */
            padding: 6px 12px;  /* 控制按鈕內邊距，讓它不會太小 */
            font-size: 14px;  /* 讓字體適中 */
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;  /* 讓按鈕有間距 */
        }
    </style>
</head>
<body>

    <!-- <h2 class="text-center mt-3">財產清冊掃描系統</h2> -->
    <div class="container mt-3">
        <div class="d-flex justify-content-center gap-3 flex-wrap my-3">
            <button class="btn btn-primary px-4" style="max-width: 200px;" onclick="toggleAssetSection()">📷 掃描功能</button>
            <button class="btn btn-success px-4" style="max-width: 200px;" onclick="toggleNewAssetSection()">➕ 新建資產</button>
            <button class="btn btn-warning px-4" style="max-width: 200px;" onclick="toggleEditAssetSection()">✏️ 編輯模式</button>
            <button class="btn btn-secondary px-4" style="max-width: 200px;" onclick="togglePrintQrSection()">📄 列印 QR Code</button>
        </div>
        
    </div>








    <div id="assetSection" class="card shadow p-4 mt-3 rounded-3">
        <div class="button-container">
            <button id="startScan" class="btn btn-primary">開始掃描</button>
            <button id="stopScan" class="btn btn-danger" style="display: none;">停止掃描</button>
        </div>


    <div id="reader"></div>
    <p>掃描結果: <span id="result"></span></p>
    
    <h3>資產資訊</h3>
    <input id="assetId" class="form-control my-3 border-primary fw-bold" placeholder="財產編號" readonly>
    <input id="assetName" class="form-control my-3" placeholder="財產名稱">
    <input id="user" class="form-control my-3" placeholder="當前使用者">
    <input id="location" class="form-control my-3" placeholder="存放位置">

    <!-- 改成下拉式選單 -->
    <select id="status" class="form-select my-2">
        <option value="正常">正常</option>
        <option value="維修中">維修中</option>
        <option value="報廢">報廢</option>
    </select>

    <button onclick="updateAsset()">更新資產</button>

    </div>
    <div id="newAssetSection" class="card shadow p-4 mt-3 rounded-3">
        <h3>新建資產</h3>
        <input id="newAssetId" placeholder="財產編號" readonly>
        <input id="newAssetName" placeholder="財產名稱">
        <input id="newUser" placeholder="當前使用者">
        <input id="newLocation" placeholder="存放位置">
    
        <select id="newStatus">
            <option value="正常">正常</option>
            <option value="維修中">維修中</option>
            <option value="報廢">報廢</option>
        </select>
    
        <button onclick="createNewAsset()">新建資產</button>

    </div>

    <div id="printQrSection" class="card shadow p-3 mt-3">
        <h4 class="text-center">📄 列印 QR Code</h4>
    

        <input id="startAssetNum" class="form-control my-2" placeholder="開始編號 (0001開始)">
        <input id="endAssetNum" class="form-control my-2" placeholder="結束編號 (比如0010)">
        <button class="btn btn-info w-100 my-2" onclick="generatePrintQrRange()">🔍 產生 QR Code</button>
        <button class="btn btn-success w-100 my-2" onclick="printQrCode()">🖨 列印 QR Code</button>
        <div id="qrPreview" class="row row-cols-2 row-cols-md-4 g-3"></div>





    </div>
    <div id="editAssetSection" class="card shadow p-4 mt-3 rounded-3" style="display: none;">
        <h3>✏️ 編輯模式</h3>
        <div class="input-group my-3">
            <span class="input-group-text">ASSET</span>
            <input id="editAssetId" type="text" class="form-control" placeholder="輸入財產編號 (如 0001)">
            <button class="btn btn-secondary w-25" onclick="editFetchAssetInfo()">確認</button>
        </div>
    
        <h3>資產資訊</h3>
        <input id="editAssetName" class="form-control my-3" placeholder="財產名稱">
        <input id="editUser" class="form-control my-3" placeholder="當前使用者">
        <input id="editLocation" class="form-control my-3" placeholder="存放位置">
    
        <select id="editStatus" class="form-select my-2">
            <option value="正常">正常</option>
            <option value="維修中">維修中</option>
            <option value="報廢">報廢</option>
        </select>
    
        <button class="btn btn-primary w-100" onclick="updateEditAsset()">✅ 更新資產</button>
    </div>

</body>
</html>
